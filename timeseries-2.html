<!DOCTYPE html>
<html lang="fr">

<head>
<title>Les séries temporelles avec Python (2/4) - Visualisations et opérations sur les séries temporelles</title>    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Statisticiens à Toulouse et Bayonne organisés en coopérative pour vous accompagner dans l'analyse de vos données" />
  <meta name="author" content="" />

  <!-- Font Awesome icons (free version)-->
  <script src="https://use.fontawesome.com/releases/v5.13.0/js/all.js" crossorigin="anonymous"></script>
  <!-- Google fonts-->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />



  <!-- <title>Le blog de Statoscop - études de cas en R et Python</title> -->
  <link rel="icon" type="image/x-icon" href="https://blog.statoscop.fr/themes/statoscop/static/images/favicon-v1.ico" />


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="https://blog.statoscop.fr/timeseries-2.html" rel="canonical" />
  <!-- Feed -->
        <link href="https://blog.statoscop.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Full Atom Feed" />
          <link href="https://blog.statoscop.fr/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Categories Atom Feed" />

  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style.css" type="text/css" rel="stylesheet" />-->
  <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style-site.css" type="text/css" rel="stylesheet" /> 
  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style_fusion.css" type="text/css" rel="stylesheet" /> -->
  <!-- Code highlight color scheme -->
      <link href="https://blog.statoscop.fr/themes/statoscop/static/css/code_blocks/github.css" rel="stylesheet">

  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!-- [if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  ![endif] -->



    <meta name="description" content="Quelques opérations sur les séries temporelles, illustré par une petite étude de cas à bicyclette.">

    <meta name="author" content="Louis">

    <meta name="tags" content="Python">
    <meta name="tags" content="Machine Learning">
    <meta name="tags" content="Statistiques">
    <meta name="tags" content="Data Science">
    <meta name="tags" content="Séries temporelles">
    <meta name="tags" content="Datetime">




<!-- Open Graph -->
<meta property="og:site_name" content="Le blog"/>
<meta property="og:title" content="Les séries temporelles avec Python (2/4) - Visualisations et opérations sur les séries temporelles"/>
<meta property="og:description" content="Quelques opérations sur les séries temporelles, illustré par une petite étude de cas à bicyclette."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://blog.statoscop.fr/timeseries-2.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-05-27 00:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://blog.statoscop.fr/author/louis.html">
<meta property="article:section" content="Python"/>
<meta property="article:tag" content="Python"/>
<meta property="article:tag" content="Machine Learning"/>
<meta property="article:tag" content="Statistiques"/>
<meta property="article:tag" content="Data Science"/>
<meta property="article:tag" content="Séries temporelles"/>
<meta property="article:tag" content="Datetime"/>
<meta property="og:image" content="https://blog.statoscop.fr/images/cover_4.png">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Les séries temporelles avec Python (2/4) - Visualisations et opérations sur les séries temporelles",
  "headline": "Les séries temporelles avec Python (2/4) - Visualisations et opérations sur les séries temporelles",
  "datePublished": "2021-05-27 00:00:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Louis",
    "url": "https://blog.statoscop.fr/author/louis.html"
  },
  "image": "https://blog.statoscop.fr/images/cover_4.png",
  "url": "https://blog.statoscop.fr/timeseries-2.html",
  "description": "Quelques opérations sur les séries temporelles, illustré par une petite étude de cas à bicyclette."
}
</script>
  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//84.16.70.79/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->

  

</head>
<!-- TODO : Body class -->
  <body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
      <div class="container">

        <a class="navbar-brand" href="https://statoscop.fr"><img src="https://blog.statoscop.fr/themes/statoscop/static/images/logo-statoscop-v1.png" alt="Statoscop.logo"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav text-uppercase ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle font-weight-bold "
                    href="https://statoscop.fr" id="navbarDropdownMenuLink" aria-haspopup="true" aria-expanded="false"> Accueil </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <li><a class="dropdown-item" href="https://statoscop.fr#services">Vos besoins</a></li>
                        <li><a class="dropdown-item" href="https://statoscop.fr#portfolio">Nos missions</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle font-weight-bold "
                    href="https://statoscop.fr/about" id="navbarDropdownMenuLink" aria-haspopup="true" aria-expanded="false"> Qui sommes-nous&#8239;? </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <li><a class="dropdown-item" href="https://statoscop.fr/about#coop">La coopérative</a></li>
                        <li><a class="dropdown-item" href="https://statoscop.fr/about#expertise">Notre expertise</a></li>
                        <li><a class="dropdown-item" href="https://statoscop.fr/about#team">L'équipe</a></li>
                    </ul>
                </li>
                <li class="nav-item font-weight-bold"><a class="nav-link js-scroll-trigger " href="https://statoscop.fr/contact">Contact</a></li>
                <li class="nav-item font-weight-bold"><a class="nav-link js-scroll-trigger active" href="https://blog.statoscop.fr/">Le blog</a></li>
            </ul>
        </div>
      </div>
    </nav>
    


    <!-- Post content -->
    <main class="content" role="main">
      
      <div>
      </div>

      <article class="post">
        <div class="inner">




            <section class="post-content">
              <h1 class="post-title">Les séries temporelles avec Python (2/4) - Visualisations et opérations sur les séries temporelles</h1>
                <!-- Le titres et meta infos-->
                <span class="post-meta">
                        <a href="https://blog.statoscop.fr/author/louis.html">Louis</a>
                    | <time datetime="jeu. 27 mai 2021">jeu. 27 mai 2021</time>
                </span>

                <!--Table des matieres
-->
                
                <div class="toc"><span class="toctitle">Table des matières</span><ul>
<li><a href="#un-peu-danglicisme-resampling-shifting-and-windowing">Un peu d'anglicisme : Resampling, Shifting, and Windowing</a><ul>
<li><a href="#reechantillonage-et-conversion-de-frequences">Rééchantillonage et conversion de fréquences</a></li>
<li><a href="#deplacements">Déplacements</a></li>
<li><a href="#attention-fenetres-glissantes">Attention, fenêtres glissantes</a></li>
</ul>
</li>
<li><a href="#un-exemple-de-visualisation-le-nombre-de-velos-a-paris-montparnasse">Un exemple de visualisation : le nombre de vélos à Paris Montparnasse</a><ul>
<li><a href="#nettoyage-des-donnees">Nettoyage des données</a></li>
<li><a href="#analyse-des-donnees">Analyse des données</a></li>
</ul>
</li>
</ul>
</div>
<p>Cet article est le second de notre série sur les données temporelles :  </p>
<ol>
<li>Introduction à la manipulation de données temporelles avec Python</li>
<li><strong>Visualisations et opérations sur les séries temporelles</strong></li>
<li>Éléments théoriques et exemples</li>
<li>Analyse, modélisation et prédiction</li>
</ol>
<p>Il s'intéresse dans un premier temps à la visualisation et aux opérations que l'on peut effectuer sur ces objets avant de conclure sur un petit exemple en utilisant les outils présentés dans ces 2 premiers posts.  </p>
<h1 id="un-peu-danglicisme-resampling-shifting-and-windowing">Un peu d'anglicisme : Resampling, Shifting, and Windowing</h1>
<ul>
<li><em>Resampling</em> = rééchantillonnage</li>
<li><em>Shifting</em> = déplacement</li>
<li><em>Windowing</em> = fenêtrage</li>
</ul>
<p>La capacité à utiliser les dates/times comme indices pour organiser et accéder aux données est le fondement des outils de séries temporelles sur Pandas. Les avantages de l'indexation (alignement, slicing, etc...) sont conservés et Pandas fournit par ailleurs plusieurs opérations spécifiques aux séries temporelles.</p>
<p>On va donc développer ici quelques unes de ces opérations merveilleuses en utilisant comme premier exemple le cours de l'action Google en bourse (données récupérées sur <a href="https://fr.finance.yahoo.com/quote/GOOG/history?p=GOOG" target="_blank">Yahoo finance</a>).</p>
<p>Petite précision en passant, le terme "séries temporelles" désigne en général, dans le contexte <code>Pandas</code>, un objet <code>Series</code> indexé par un <code>DatetimeIndex</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># parse_dates=True permet à pandas de repérer les dates sous différents formats</span>
<span class="n">goog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/GOOG.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">goog</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-08-19</th>
      <td>49.813290</td>
      <td>51.835709</td>
      <td>47.800831</td>
      <td>49.982655</td>
      <td>49.982655</td>
      <td>44871361</td>
    </tr>
    <tr>
      <th>2004-08-20</th>
      <td>50.316402</td>
      <td>54.336334</td>
      <td>50.062355</td>
      <td>53.952770</td>
      <td>53.952770</td>
      <td>22942874</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="n">goog</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-05-21</th>
      <td>2365.98999</td>
      <td>2369.00000</td>
      <td>2342.370117</td>
      <td>2345.100098</td>
      <td>2345.100098</td>
      <td>1139600</td>
    </tr>
    <tr>
      <th>2021-05-24</th>
      <td>2367.00000</td>
      <td>2418.47998</td>
      <td>2360.110107</td>
      <td>2406.669922</td>
      <td>2406.669922</td>
      <td>1061400</td>
    </tr>
  </tbody>
</table>
</div>

<p>Ces données recensent certaines informations sur l'action Google du 19 août 2004 au 24 mai 2021 : les prix à l'ouverture et à la clôture, le maximum et le minimum sur la journée, les prix ajustés et les volumes. On étudie ici la série temporelle des prix à la clôture.</p>
<div class="highlight"><pre><span></span><code><span class="n">goog</span> <span class="o">=</span> <span class="n">goog</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="n">goog</span><span class="o">.</span><span class="n">index</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">DatetimeIndex</span><span class="p">(</span><span class="o">[</span><span class="n">&#39;2004-08-19&#39;, &#39;2004-08-20&#39;, &#39;2004-08-23&#39;, &#39;2004-08-24&#39;,</span>
<span class="n">               &#39;2004-08-25&#39;, &#39;2004-08-26&#39;, &#39;2004-08-27&#39;, &#39;2004-08-30&#39;,</span>
<span class="n">               &#39;2004-08-31&#39;, &#39;2004-09-01&#39;,</span>
<span class="n">               ...</span>
<span class="n">               &#39;2021-05-11&#39;, &#39;2021-05-12&#39;, &#39;2021-05-13&#39;, &#39;2021-05-14&#39;,</span>
<span class="n">               &#39;2021-05-17&#39;, &#39;2021-05-18&#39;, &#39;2021-05-19&#39;, &#39;2021-05-20&#39;,</span>
<span class="n">               &#39;2021-05-21&#39;, &#39;2021-05-24&#39;</span><span class="o">]</span><span class="p">,</span>
<span class="w">              </span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">=</span><span class="mi">4220</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="o">=</span><span class="k">None</span><span class="p">)</span>
</code></pre></div>

<p>C'est bien une série indexée par un <code>DatetimeIndex</code> que l'on affiche avec style en fixant les paramètres d'affichage par défaut comme étant ceux de <code>seaborn</code> : </p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> <span class="p">;</span> <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span> <span class="c1">#pour définir les paramètres d&#39;affichage de seaborn par défaut</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">goog</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_9_0.png"></p>
<h2 id="reechantillonage-et-conversion-de-frequences">Rééchantillonage et conversion de fréquences</h2>
<p>Une manipulation classique des séries temporelles est le rééchantionnage (resampling) à une fréquence plus ou moins haute. Cela consiste à augmenter ou diminuer la fréquence des observations. Il y a donc 2 possibilités :<br>
- si on augmente la fréquence cela veut dire ajouter des points et dans ce cas il faut définir quelle stratégie utiliser pour interpoler les nouveaux points (un exemple de stratégie basique est de répéter la dernière valeur) ;<br>
- si on diminue la fréquence, ce qui est le cas le plus classique, on va supprimer des points et il faut là aussi déterminer la stratégie à utiliser. Deux options sont possibles : on sélectionne uniquement les points correspondants à la nouvelle fréquence plus faible ou bien on agrège les points entre 2 fréquences en utilisant une fonction d'aggrégation comme par exemple une moyenne, une médiane, un max, etc...</p>
<p>Pour ce faire, <code>pandas</code> dispose de deux méthodes qui sont <code>resample()</code> ou <code>asfreq()</code>. La différence entre les deux est que <code>resample</code> consiste à agréger toutes les données comprises entre 2 multiples de la fréquence alors que <code>asfreq</code> sélectionne la valeur correspondant à la fréquence. Aussi, <code>resample</code> renvoie un objet particulier qui est un <code>DatetimeIndexResampler</code> sur lequel il faut appliquer une méthode d'aggrégation ou d'imputation pour récupérer une série. La méthode <code>asfreq</code> retourne directement une série.</p>
<p>On va de ce pas illustrer avec la série Google en diminuant la fréquence afin de n'avoir qu'un point par année. On va prendre le dernier jour ouvrable de l'année (jour ouvrable car la série prend des valeurs uniquement pour les jours ouvrables).</p>
<p>Petit rappel, on utilise ci-dessous, le code de fréquence <code>BA</code> pour récupérer le dernier jour ouvrable de l'année mais pour en savoir plus sur les fréquences, <a href="https://blog.statoscop.fr/timeseries-1.html" target="_blank">l'épisode 1 de cette série</a> vous en apprendra davantage.</p>
<div class="highlight"><pre><span></span><code><span class="n">goog</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">goog</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;BA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">goog</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;BA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;resample&#39;</span><span class="p">,</span> <span class="s1">&#39;asfreq&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_14_0.png"></p>
<p>Pour un resampling avec une fréquence plus importante, <code>resample()</code> et <code>asfreq()</code> sont équivalentes. Par défaut, les 2 méthodes laissent les valeurs non existantes vides. Toutefois, <code>asfreq()</code> accepte un paramètre <code>method</code> dans lequel on peut spécifier comment imputer les valeurs manquantes générées par l'augmentation de la fréquence. C'est faisable aussi avec <code>resample</code> en utilisant les méthodes <code>bfill</code> ou <code>ffill</code> des objets <code>pandas.core.resample.Resampler</code>.</p>
<p>Le petit bout de code ci-dessous selectionne uniquement les 14 derniers jours et effectue un resampling de la série avec une fréquence quotidienne (cela inclue donc les weekends !). Ensuite on affiche pour chaque méthode (<code>resample()</code> et <code>asfreq()</code>) les courbes rééchantillonnées sans imputer les valeurs manquantes, avec une imputation de type <code>bfill</code> qui impute la première valeur suivante non manquante (donc dans ce cas celle du lundi) et de type <code>ffill</code> qui impute la dernière valeur (donc ici, celle du vendredi).</p>
<div class="highlight"><pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="n">goog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">14</span><span class="p">:]</span>

<span class="c1">#visualisation</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="c1">#avec asfreq</span>
<span class="n">data</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;asfreq()&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="n">data</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;-o&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;--o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;back-fill&quot;</span><span class="p">,</span> <span class="s2">&quot;forward-fill&quot;</span><span class="p">]);</span>

<span class="c1">#avec resample</span>
<span class="n">data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;resample()&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="n">data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;-o&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;--o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;back-fill&quot;</span><span class="p">,</span> <span class="s2">&quot;forward-fill&quot;</span><span class="p">]);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_16_0.png"></p>
<h2 id="deplacements">Déplacements</h2>
<p>Une autre opération fondamentale de l'analyse des données temporelles est le déplacement ou décalage (on parle plus souvent de <em>time-shifts</em> ou <em>shifting</em>)</p>
<p>On utilise pour cette opération la méthode <code>shift()</code> dont le principe est de déplacer les valeurs par rapport aux indices. Le décalage doit bien sûr être un multiple de la fréquence !</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">goog</span> <span class="o">=</span> <span class="n">goog</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>

<span class="n">goog</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">goog</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">900</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">goog</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">900</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">local_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">)</span>
<span class="n">offset1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">offset2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="o">-</span><span class="mi">900</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">local_max</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;shift(900)&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">local_max</span> <span class="o">+</span> <span class="n">offset1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;shift(-900)&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">local_max</span> <span class="o">+</span> <span class="n">offset2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_18_0.png"></p>
<p>Une utilisation possible du <em>shifting</em> est par exemple de calculer le retour sur investissement à 1 an de l'action de Google (ROI - <em>return on investment</em>, par ici <a href="https://en.wikipedia.org/wiki/Return_on_investment" target="_blank">Wiki</a>).</p>
<div class="highlight"><pre><span></span><code><span class="n">ROI_1</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">goog</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">365</span><span class="p">)</span> <span class="o">/</span> <span class="n">goog</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ROI_1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">365</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_20_0.png"></p>
<p>Qu'en conclure ? Pour les boursicoteurs, vous avez raté le coche, fallait acheter en 2004 ou en 2009.</p>
<h2 id="attention-fenetres-glissantes">Attention, fenêtres glissantes</h2>
<p>Enfin, la 3ème opération classique des séries temporelles consiste à calculer différentes statistiques sur une fenêtre d'une longueur donnée et qui se déplace. On parle plus de <em>rolling window</em> que de fenêtres glissantes...et pour ce faire, Pandas a tout ce qu'il faut avec la méthode <code>rolling()</code> pour les objets <code>Series</code> et <code>DataFrame</code>. Regardons d'un peu plus près en calculant avec la méthode rolling la moyenne annuelle centrée et l'écart-type annuel centré.</p>
<div class="highlight"><pre><span></span><code><span class="n">rol</span> <span class="o">=</span> <span class="n">goog</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">365</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">goog</span><span class="p">,</span>
                     <span class="s1">&#39;moyenne&#39;</span><span class="p">:</span> <span class="n">rol</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                     <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">rol</span><span class="o">.</span><span class="n">std</span><span class="p">()})</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_23_0.png"></p>
<h1 id="un-exemple-de-visualisation-le-nombre-de-velos-a-paris-montparnasse">Un exemple de visualisation : le nombre de vélos à Paris Montparnasse</h1>
<p>On va terminer sur un petit exemple un peu plus parlant, ou en tout cas, un peu moins financier, en regardant le nombre de vélos passés devant un des compteurs de la ville de Paris, situé sur le boulevard Montparnasse. Le jeu de données vient <a href="https://opendata.paris.fr/explore/dataset/comptage-velo-donnees-compteurs/information/?disjunctive.id_compteur&disjunctive.nom_compteur&disjunctive.id&disjunctive.name" target="_blank">de là</a>. On récupère ainsi le décompte horaire des vélos.</p>
<h2 id="nettoyage-des-donnees">Nettoyage des données</h2>
<p>Un premier coup d'oeil sur les données nous permet de voir qu'il y a beaucoup de colonnes inutiles dans ce dataset. On va donc se contenter de ce qui nous intéresse : le timestamp et le nombre de vélos. Avec un petit peu de nettoyage directement au moment de l'import dans le <code>pandas.read_csv</code>, ça donne :</p>
<div class="highlight"><pre><span></span><code><span class="n">velo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/comptage-velo-donnees-compteurs.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span>
                   <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nb&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">velo</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>nb</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>21.0</td>
      <td>2020-04-01T07:00:00+02:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>21.0</td>
      <td>2020-04-01T09:00:00+02:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14.0</td>
      <td>2020-04-01T12:00:00+02:00</td>
    </tr>
  </tbody>
</table>
</div>

<p>En important le jeu de données, on voit ce "+02:00" qui définit en fait la timezone. Plusieurs solutions possibles pour gérer ce problème :<br>
- on peut utiliser les méthodes de manipulation de timezone avec <code>tz_convert</code> et <code>tz_localize</code><br>
- on peut définir notre propre parser de date au moment de l'import en supprimant le "+02:00" avec un <code>split</code> par exemple.</p>
<p>Ci-dessous, ces 2 approches mises en oeuvre.</p>
<div class="highlight"><pre><span></span><code><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">velo</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;Europe/Paris&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">DatetimeIndex</span><span class="p">(</span><span class="o">[</span><span class="n">&#39;2020-04-01 07:00:00&#39;, &#39;2020-04-01 09:00:00&#39;,</span>
<span class="n">               &#39;2020-04-01 12:00:00&#39;, &#39;2020-04-01 15:00:00&#39;,</span>
<span class="n">               &#39;2020-04-01 16:00:00&#39;, &#39;2020-04-01 19:00:00&#39;,</span>
<span class="n">               &#39;2020-04-01 20:00:00&#39;, &#39;2020-04-01 21:00:00&#39;,</span>
<span class="n">               &#39;2020-04-01 22:00:00&#39;, &#39;2020-04-01 23:00:00&#39;,</span>
<span class="n">               ...</span>
<span class="n">               &#39;2021-05-22 20:00:00&#39;, &#39;2021-05-23 00:00:00&#39;,</span>
<span class="n">               &#39;2021-05-23 02:00:00&#39;, &#39;2021-05-23 03:00:00&#39;,</span>
<span class="n">               &#39;2021-05-23 04:00:00&#39;, &#39;2021-05-23 16:00:00&#39;,</span>
<span class="n">               &#39;2021-05-23 19:00:00&#39;, &#39;2021-05-24 02:00:00&#39;,</span>
<span class="n">               &#39;2021-05-24 05:00:00&#39;, &#39;2021-05-24 14:00:00&#39;</span><span class="o">]</span><span class="p">,</span>
<span class="w">              </span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">=</span><span class="mi">10046</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="o">=</span><span class="k">None</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">velo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/comptage-velo-donnees-compteurs.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span>
                   <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nb&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
                   <span class="n">index_col</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
                   <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">date_parser</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                  <span class="p">)</span>
<span class="c1"># read_csv retourne un dataframe or on veut un objet Series, donc puisqu&#39;on le veut, et qu&#39;on l&#39;a, ben on le prend.</span>
<span class="n">velo</span> <span class="o">=</span> <span class="n">velo</span><span class="o">.</span><span class="n">nb</span>
<span class="n">velo</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nx">date</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="mi">07</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="w">    </span><span class="m m-Double">21.0</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="mi">09</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="w">    </span><span class="m m-Double">21.0</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="w">    </span><span class="m m-Double">14.0</span>
<span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">nb</span><span class="p">,</span><span class="w"> </span><span class="nx">dtype</span><span class="p">:</span><span class="w"> </span><span class="nx">float64</span>
</code></pre></div>

<p>Regardons à quoi ressemble cette série temporelle du nombre de vélos sur le boulevard Montparnasse ! </p>
<div class="highlight"><pre><span></span><code><span class="n">velo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Décompte horaire des vélos&#39;</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_32_0.png"></p>
<p>On voit pas grand chose pour le moment mais on détecte déjà un problème de valeurs manquantes au niveau du mois de février 2021. On va donc prendre les données de 2020 uniquement pour s'épargner la gestion de ces données manquantes.</p>
<div class="highlight"><pre><span></span><code><span class="n">velo</span> <span class="o">=</span> <span class="n">velo</span><span class="p">[</span><span class="s1">&#39;2020&#39;</span><span class="p">]</span>
<span class="n">velo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Décompte horaire des vélos&#39;</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_34_0.png"></p>
<h2 id="analyse-des-donnees">Analyse des données</h2>
<p>La série par heure étant trop "dense" pour être clairement lisible, on va diminuer la fréquence avec un <code>resample</code> pour faire la somme des vélos sur une journée et sur une semaine.</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="c1"># Somme sur une journée</span>
<span class="n">velo_jr</span> <span class="o">=</span>  <span class="n">velo</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">velo_jr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Décompte journalier des vélos&#39;</span><span class="p">);</span>

<span class="c1"># Somme sur une semaine</span>
<span class="n">velo_sem</span> <span class="o">=</span>  <span class="n">velo</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">velo_sem</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Décompte hebdo des vélos&#39;</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_36_0.png"></p>
<p>Avec ces rééchantillonages on veut une tendance annuelle qui se dégage avec notamment un pic de reprise d'activité au printemps, après le confinement et une baisse de fréquentation pendant l'été. De la même manière, la baisse significative visible au mois de novembre est certainement dûe au second confinement de 2020.</p>
<p>Une autre information visible sur le graphique des décomptes journaliers est la baisse du nombre de vélo environ 4 fois par mois, cela correspond certainement aux weekends mais ne nous avançons pas trop...</p>
<p>On va regarder avec la méthode <code>rolling</code>, la moyenne mobile mensuelle et faire jouer certains paramètres afin de voir ce qu'il en est.</p>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">velo_jr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;unweighted&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">velo_jr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">win_type</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;win</span><span class="si">{</span><span class="n">std</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_38_0.png"></p>
<p>Le paramètre <code>win_type="gaussian"</code> permet d'appliquer une pondération au calcul de la moyenne. En l'occurence on applique des poids qui suivent une loi normale dont l'écart-type est défini dans la fonction d'aggrégation <code>mean</code>. Plus cet écart-type est faible, plus les jours proches comptent et ceux éloignés ne comptent pas. C'est le cas de la courbe orange qui a donc tendance à suivre d'assez près la courbe initiale. En revanche, si l'on augmente l'écart-type, on prend en compte plus de jours autour et on lisse ainsi les résultats. Pour finir, si l'écart-type est très élevé, alors on pondère de manière quasi identique les 30 jours de la fenêtre et on retombe donc sur une moyenne non-pondérée.</p>
<p>On va regarder maintenant comment ça se passe au niveau hebdomadaire pour comprendre comment évolue la fréquentation selon les différents horaires d'une journée et selon les différents jours d'une semaine. Pour cela, on va pouvoir utiliser les attributs <code>time</code> et <code>dayofweek</code> des objets <code>DatetimeIndex</code> afin d'afficher les décomptes de vélos par heure de la journée et par jour de la semaine.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">par_hr</span> <span class="o">=</span> <span class="n">velo</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">velo</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">heures</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">par_hr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="o">=</span><span class="n">heures</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>

<span class="n">par_sem</span> <span class="o">=</span> <span class="n">velo</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">velo</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">par_sem</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lundi&#39;</span><span class="p">,</span> <span class="s1">&#39;Mardi&#39;</span><span class="p">,</span> <span class="s1">&#39;Mercredi&#39;</span><span class="p">,</span> <span class="s1">&#39;Jeudi&#39;</span><span class="p">,</span> <span class="s1">&#39;Vendredi&#39;</span><span class="p">,</span> <span class="s1">&#39;Samedi&#39;</span><span class="p">,</span> <span class="s1">&#39;Dimanche&#39;</span><span class="p">]</span>
<span class="n">par_sem</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_40_0.png"></p>
<p>On retrouve bien certaines informations qu'on avait évoquées : <br>
- baisse de la fréquentation le weekend et sur une journée,<br>
- pics de fréquentation à 8h et à 18h et légère augmentation à l'heure du déjeuner.</p>
<p>Cette 2ème information est certes logique pour les jours ouvrables mais c'est plus étonnant pour les jours de weekends...allons voir de plus près !</p>
<div class="highlight"><pre><span></span><code><span class="n">jours_ouvrables</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">velo</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Ouvrable&#39;</span><span class="p">,</span> <span class="s1">&#39;Weekend&#39;</span><span class="p">)</span>
<span class="n">par_hr</span> <span class="o">=</span> <span class="n">velo</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">jours_ouvrables</span><span class="p">,</span> <span class="n">velo</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">time</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">par_hr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Ouvrable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Jours ouvrables&#39;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">heures</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">par_hr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Weekend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Weekends&#39;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">heures</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</code></pre></div>

<p><img alt="Pelican" src="../images/SeriesTemp2/output_43_0.png"></p>
<p>C'est tout de suite plus clair : le weekend, les gens dorment et sortent se promener l'après-midi ! Nous voilà rassurés. Sur cette belle découverte, on se dit à très vite pour le post numéro 3 de cette série ! Comme d'habitude, vous pouvez retrouver l'ensemble du notebook ayant servi à générer cette note sur le <a href="https://github.com/Statoscop/notebooks-blog" target="_blank">github de Statoscop</a>.</p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Les séries temporelles avec Python (2/4) - Visualisations et opérations sur les séries temporelles&amp;url=https://blog.statoscop.fr/timeseries-2.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://blog.statoscop.fr/tag/python.html">Python</a><a href="https://blog.statoscop.fr/tag/machine-learning.html">Machine Learning</a><a href="https://blog.statoscop.fr/tag/statistiques.html">Statistiques</a><a href="https://blog.statoscop.fr/tag/data-science.html">Data Science</a><a href="https://blog.statoscop.fr/tag/series-temporelles.html">Séries temporelles</a><a href="https://blog.statoscop.fr/tag/datetime.html">Datetime</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
    
    <!-- Footer-->
    <footer class="footer py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 text-lg-left"> © Statoscop</div>
                <div class="col-lg-4 my-3 my-lg-0">
                    <a class="btn btn-dark btn-social mx-2" href="https://twitter.com/stato_scop" target="_blank"><i class="fab fa-twitter"></i></a>
                </div>
                <div class="col-lg-4 text-lg-left"> 
                    Blog publié avec <a class="js-scroll-trigger text-info" href="https://docs.getpelican.com/en/latest/"  target="_blank">Pelican</a> et
                     déployé sur <a class="js-scroll-trigger text-info" href="https://pages.github.com/"  target="_blank">Github Pages</a>.
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap core JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
    <!-- Third party plugin JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script type="text/javascript" src="https://blog.statoscop.fr/themes/statoscop/static/js/script.js"></script>

  </body>
</html>
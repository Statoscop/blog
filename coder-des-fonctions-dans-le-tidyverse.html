<!DOCTYPE html>
<html lang="fr">

<head>
<title>Coder des fonctions dans le tidyverse</title>    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Le blog statistiques et data science de la coopérative Statoscop" />
  <meta name="author" content="" />

  <!-- Font Awesome icons (free version)-->
  <script src="https://use.fontawesome.com/releases/v5.13.0/js/all.js" crossorigin="anonymous"></script>
  <!-- Google fonts-->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />



  <!-- <title>Le blog de Statoscop - études de cas en R et Python</title> -->
  <link rel="icon" type="image/x-icon" href="https://blog.statoscop.fr/themes/statoscop/static/images/favicon-v1.ico" />


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="https://blog.statoscop.fr/coder-des-fonctions-dans-le-tidyverse.html" rel="canonical" />
  <!-- Feed -->
        <link href="https://blog.statoscop.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Full Atom Feed" />
          <link href="https://blog.statoscop.fr/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Categories Atom Feed" />

  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style.css" type="text/css" rel="stylesheet" />-->
  <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style-site.css" type="text/css" rel="stylesheet" /> 
  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style_fusion.css" type="text/css" rel="stylesheet" /> -->
  <!-- Code highlight color scheme -->
      <link href="https://blog.statoscop.fr/themes/statoscop/static/css/code_blocks/github.css" rel="stylesheet">

  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!-- [if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  ![endif] -->



    <meta name="description" content="Quelques trucs pour coder facilement ses propres fonctions en utilisant la syntaxe du tidyverse.">

    <meta name="author" content="Antoine">

    <meta name="tags" content="R">
    <meta name="tags" content="Rstats">
    <meta name="tags" content="tidyverse">
    <meta name="tags" content="dplyr">
    <meta name="tags" content="across">




<!-- Open Graph -->
<meta property="og:site_name" content="Le blog"/>
<meta property="og:title" content="Coder des fonctions dans le tidyverse"/>
<meta property="og:description" content="Quelques trucs pour coder facilement ses propres fonctions en utilisant la syntaxe du tidyverse."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://blog.statoscop.fr/coder-des-fonctions-dans-le-tidyverse.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2023-11-28 00:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://blog.statoscop.fr/author/antoine.html">
<meta property="article:section" content="R"/>
<meta property="article:tag" content="R"/>
<meta property="article:tag" content="Rstats"/>
<meta property="article:tag" content="tidyverse"/>
<meta property="article:tag" content="dplyr"/>
<meta property="article:tag" content="across"/>
<meta property="og:image" content="https://blog.statoscop.fr/images/cover_16.png">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Coder des fonctions dans le tidyverse",
  "headline": "Coder des fonctions dans le tidyverse",
  "datePublished": "2023-11-28 00:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Antoine",
    "url": "https://blog.statoscop.fr/author/antoine.html"
  },
  "image": "https://blog.statoscop.fr/images/cover_16.png",
  "url": "https://blog.statoscop.fr/coder-des-fonctions-dans-le-tidyverse.html",
  "description": "Quelques trucs pour coder facilement ses propres fonctions en utilisant la syntaxe du tidyverse."
}
</script>
  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//matomo.statoscop.fr/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->

  

</head>
<!-- TODO : Body class -->
  <body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
      <div class="container">

        <a class="navbar-brand" href="https://statoscop.fr"><img src="https://blog.statoscop.fr/themes/statoscop/static/images/logo-statoscop-v1.png" alt="Statoscop.logo"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav text-uppercase ml-auto">
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger " href="https://statoscop.fr"> Accueil </a>
              </li>
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger " href="https://statoscop.fr/about"> À propos </a>
              </li>
              <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle font-weight-bold "
                  id="navbarDropdownMenuLink" aria-haspopup="true" aria-expanded="false"> Prestations </a>
                  <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                      <li><a class="dropdown-item" href="https://statoscop.fr/etudes">Conseils & études statistiques</a></li>
                      <li><a class="dropdown-item" href="https://statoscop.fr/recodages">Migrations de code & Recodages</a></li>
                      <li><a class="dropdown-item" href="https://statoscop.fr/formations">Formations</a></li>
                      <li><a class="dropdown-item" href="https://statoscop.fr/applis">Dashboards & Applications</a></li>
                  </ul>
              </li>
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger " href="https://statoscop.fr/contact">Contact</a>
              </li>
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger active" href="https://blog.statoscop.fr/">Le blog</a>
              </li>
          </ul>
      </div>
      </div>
    </nav>
    


    <!-- Post content -->
    <main class="content" role="main">
      
      <div>
      </div>

      <article class="post">
        <div class="inner">




            <section class="post-content">
              <h1 class="post-title">Coder des fonctions dans le tidyverse</h1>
                <!-- Le titres et meta infos-->
                <span class="post-meta">
                        <a href="https://blog.statoscop.fr/author/antoine.html">Antoine</a>
                    | <time datetime="mar. 28 novembre 2023">mar. 28 novembre 2023</time>
                </span>

                <!--Table des matieres
-->
                
                <div class="toc"><span class="toctitle">Table des matières</span><ul>
<li><a href="#le-tidyverse-et-levaluation-non-standard">Le tidyverse et l'évaluation non standard</a></li>
<li><a href="#faire-reference-aux-parametres-de-ma-fonction">Faire référence aux paramètres de ma fonction</a><ul>
<li><a href="#parametres-renseignes-en-symboles">Paramètres renseignés en symboles</a></li>
<li><a href="#parametres-renseignes-en-chaines-de-caracteres">Paramètres renseignés en chaînes de caractères</a></li>
<li><a href="#nommer-des-variables-en-fonction-des-parametres">Nommer des variables en fonction des paramètres</a></li>
</ul>
</li>
<li><a href="#coder-une-fonction-avec-nimporte-quel-nombre-de-parametres">Coder une fonction avec n'importe quel nombre de paramètres</a><ul>
<li><a href="#utilisation-dacross">Utilisation d'across</a></li>
<li><a href="#utilisation-de-pick-et">Utilisation de pick et ...</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<p>Dans cet article, on s'intéresse aux manières de coder des fonctions en utilisant la syntaxe du <code>tidyverse</code>. Après avoir rappelé quelques principes de l'évaluation non standard dans le tidyverse, on présente concrètement les manières de faire référence aux paramètres de notre fonction, qu'ils soient renseignés sous forme de symboles ou de chaînes de caractères. On termine avec des astuces pour coder des fonctions plus flexibles, notamment sans avoir à fixer le nombre de paramètres en amont.</p>
<h1 id="le-tidyverse-et-levaluation-non-standard">Le tidyverse et l'évaluation non standard</h1>
<p>La syntaxe du <code>tidyverse</code> s'appuie sur des fonctions aux noms explicites et une grande facilité d'utilisation. Le principe est de rendre le code le plus lisible possible. Tout cela permet de coder de manière intuitive et peu verbeuse. Mais lorsqu'il s'agit de coder ses propres fonctions, les choses se compliquent. Prenons par exemple la fonction suivante, qui permet de donner le nombre d'observations d'un dataframe dont une valeur numérique est inférieure à un certain seuil :  </p>
<div class="highlight"><pre><span></span><code><span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="c1">## </span>
<span class="c1">## Attachement du package : &#39;dplyr&#39;</span>
<span class="c1">## Les objets suivants sont masqués depuis &#39;package:stats&#39;:</span>
<span class="c1">## </span>
<span class="c1">##     filter, lag</span>
<span class="c1">## Les objets suivants sont masqués depuis &#39;package:base&#39;:</span>
<span class="c1">## </span>
<span class="c1">##     intersect, setdiff, setequal, union</span>

<span class="n">my_filter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">x1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">seuil</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">nrow</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>L'appel de cette fonction pour obtenir le nombre de voitures avec <code>mpg &lt;= 20</code> donne l'erreur suivante:  </p>
<div class="highlight"><pre><span></span><code><span class="nf">data</span><span class="p">(</span><span class="n">mtcars</span><span class="p">)</span>

<span class="nf">my_filter</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpg</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span>
<span class="c1">## Error in `filter()`:</span>
<span class="c1">## ℹ In argument: `x1 &lt;= seuil`.</span>
<span class="c1">## Caused by error:</span>
<span class="c1">## ! objet &#39;mpg&#39; introuvable</span>
</code></pre></div>

<p>Cette erreur est la conséquence d'une propriété importante du <code>tidyverse</code> : le <strong>data masking</strong>. C'est ce qui fait que les verbes de dplyr évaluent l'appel d'une fonction à un objet au sein du dataframe auquel elle s'applique. Ainsi, on fait appel à des fonctions avec la syntaxe fonction(<code>data</code>, <code>var1</code>, <code>var2</code>, <code>var3</code>) et non fonction(<code>data$var1</code>, <code>data$var2</code>, <code>data$var3</code>). Couplé à l'utilisation du <em>pipe</em> (que ce soit le <code>%&gt;%</code> de <code>magritr</code> ou le récent <code>|&gt;</code> de R auquel nous commençons à nous convertir), cette fonctionnalité permet d'obtenir un code bien plus aisé et agréable à écrire et à lire. Ainsi, dans <code>dplyr</code>, on considère un peu <strong>le dataframe comme un environnement</strong> et les colonnes de ce dataframe comme des éléments de cet environnement. </p>
<p>Seulement voilà, cette évaluation n'est pas non-standard pour rien : ici lors de l'appel de <code>my_filter</code> l'objet <code>mpg</code> est cherché dans l'environnement et il n'est pas trouvé. Et pour cause : il n'existe pas, contrairement à <code>mtcars$mpg</code>. </p>
<h1 id="faire-reference-aux-parametres-de-ma-fonction">Faire référence aux paramètres de ma fonction</h1>
<p>Comment donc coder comme un développeur de Posit et profiter de cette syntaxe avantageuse? Si les choses ne sont pas aussi simples et intuitives qu'avec base R, elles se sont récemment simplifiées et ne devraient pas vous poser trop de problèmes.  </p>
<h2 id="parametres-renseignes-en-symboles">Paramètres renseignés en symboles</h2>
<p>Si les paramètres sont renseignés "en dur", ou en symboles, comme c'est le cas dans les verbes de <code>dplyr</code>, on privilégiera l'écriture <code>{{ var }}</code>. Elle s'est récemment substituée à l'ancienne option, plus énigmatique, de <code>!!enquo(var)</code>. <br>
Testons cela sur notre petite fonction :  </p>
<div class="highlight"><pre><span></span><code><span class="n">my_filter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">({{</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">seuil</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">nrow</span><span class="p">()</span>
<span class="p">}</span>
<span class="nf">my_filter</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpg</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span>
<span class="c1">## [1] 18</span>
</code></pre></div>

<p>Merveilleux! Mais si, pour une raison ou pour une autre, vous souhaiteriez que l'utilisateur de votre fonction entre le paramètre sous forme de chaîne de caractère?</p>
<h2 id="parametres-renseignes-en-chaines-de-caracteres">Paramètres renseignés en chaînes de caractères</h2>
<p>Dans ce cas, on revient à une notation classique de base R : <code>df[["var"]]</code>. Sauf que, dans un contexte d'expressions chaînées, on va utiliser la notation bien utile <code>.data[["var"]]</code> qui fait référence au dataframe de la chaîne d'expression <strong>dans son état au moment de l'appel</strong>. En effet, si je voulais faire référence au dataframe par son nom je pourrais me retrouver dans cette situation :  </p>
<div class="highlight"><pre><span></span><code><span class="n">mtcars</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">mpg</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">20</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">transmute</span><span class="p">(</span><span class="n">carb_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtcars</span><span class="p">[[</span><span class="s">&quot;carb&quot;</span><span class="p">]]</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="c1">## Error in `transmute()`:</span>
<span class="c1">## ℹ In argument: `carb_2 = mtcars[[&quot;carb&quot;]]^2`.</span>
<span class="c1">## Caused by error:</span>
<span class="c1">## ! `carb_2` must be size 18 or 1, not 32.</span>
</code></pre></div>

<p>Les tailles des vecteurs ne correspondent pas! En effet, le filtre appliqué n'est pas pris en compte au moment de l'appel à la variable <code>carb</code>. La notation <code>.data</code> résoud bien ce souci :  </p>
<div class="highlight"><pre><span></span><code><span class="n">mtcars</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">mpg</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">20</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">transmute</span><span class="p">(</span><span class="n">carb_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.data</span><span class="p">[[</span><span class="s">&quot;carb&quot;</span><span class="p">]]</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="c1">##                   carb_2</span>
<span class="c1">## Hornet Sportabout      4</span>
</code></pre></div>

<p>Pour en revenir à notre fonction, il est donc très aisé avec cette notation de définir le paramètre en chaîne de caractères :  </p>
<div class="highlight"><pre><span></span><code><span class="n">my_filter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">.data</span><span class="p">[[</span><span class="n">x1</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">seuil</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">nrow</span><span class="p">()</span>
<span class="p">}</span>
<span class="nf">my_filter</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mpg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span>
<span class="c1">## [1] 18</span>
</code></pre></div>

<p>Mais si vous préférez l'ancienne notation, pour les paramètres renseignés en chaînes de caractères c'est la suivante :  </p>
<div class="highlight"><pre><span></span><code><span class="n">my_filter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="o">!!</span><span class="nf">sym</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">seuil</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">nrow</span><span class="p">()</span>
<span class="p">}</span>
<span class="nf">my_filter</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mpg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span>
<span class="c1">## [1] 18</span>
</code></pre></div>

<h2 id="nommer-des-variables-en-fonction-des-parametres">Nommer des variables en fonction des paramètres</h2>
<p>Imaginons maintenant que nous voulions créer une indicatrice en fonction du seuil d'une variable numérique, et que nous aimerions nommer cette indicatrice en fonction de la variable numérique qu'elle décrit :  </p>
<div class="highlight"><pre><span></span><code><span class="n">my_indic</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">x1_indic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">if_else</span><span class="p">({{</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">seuil</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p>Dans cette version ma nouvelle variable va s'appeler <code>x1_indic</code>, et non prendre le nom de la variable numérique de <code>x1</code>. Et là encore c'est la double accolade qui va nous permettre de résoudre ce problème, mais pas seulement. Pour cela, on fait <strong>référence au nom du paramètre au sein d'une double accolade</strong>. De plus, le nom de la variable ainsi créée est donné entre guillemets. On peut également ajouter d'autres caractères. Enfin, <strong>le signe <code>=</code> doit être remplacé par <code>:=</code></strong>. Cela donne :  </p>
<div class="highlight"><pre><span></span><code><span class="n">my_indic</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="s">&quot;{{ x1 }}_indic&quot;</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">if_else</span><span class="p">({{</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">seuil</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p>On vérifie avec <code>mpg</code> que la variable <code>mpg_indic</code> est bien créé :  </p>
<div class="highlight"><pre><span></span><code><span class="nf">my_indic</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">mpg</span><span class="p">,</span><span class="w"> </span><span class="n">seuil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="n">mpg_indic</span><span class="p">)</span>
<span class="c1">##   mpg_indic  n</span>
<span class="c1">## 1         0 14</span>
<span class="c1">## 2         1 18</span>
</code></pre></div>

<h1 id="coder-une-fonction-avec-nimporte-quel-nombre-de-parametres">Coder une fonction avec n'importe quel nombre de paramètres</h1>
<p>Essayons maintenant d'aller un peu plus loin! On explore dans cette partie <strong>des manières plus flexibles de coder nos fonctions</strong>, sans fixer à l'avance le nombre de paramètres.  </p>
<h2 id="utilisation-dacross">Utilisation d'<code>across</code></h2>
<p>La solution la plus directe pour permettre à l'utilisateur de votre fonction de définir le nombre de paramètres qu'il souhaite est en général d'utiliser la puissance d'<code>across()</code>. On parle de manière détaillée de ce verbe dans <a href="https://blog.statoscop.fr/fonctionnement-et-performances-dacross-dans-dplyr.html">cet article de notre blog</a>. Vous pouvez également explorer toutes ses possibilités dans <a href="https://www.icem7.fr/r/across-plus-puissant-flexible-quil-ny-parait/">cet article du blog d'Icem7</a>. <br>
Dans le cas d'une fonction, c'est aussi la syntaxe <code>{{ var }}</code> qui nous permettra de l'utiliser. Imaginez par exemple que vous souhaitiez créer une fonction permettant des statistiques sur un certain nombre de variables définies par l'utilisateur. Une telle fonction s'écrirait ainsi :  </p>
<div class="highlight"><pre><span></span><code><span class="n">mean_multiple_var</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">({{</span><span class="w"> </span><span class="n">vars_mean</span><span class="w"> </span><span class="p">}},</span><span class="w"> </span><span class="n">mean</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<p>On peut ensuite appeler la fonction en définissant <strong>le paramètre <code>vars_mean</code> comme un vecteur de symboles</strong>, ou comme un seul symbole dans le cas où on ne voudrait la moyenne que d'une variable :  </p>
<div class="highlight"><pre><span></span><code><span class="nf">mean_multiple_var</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disp</span><span class="p">)</span>
<span class="c1">##       disp</span>
<span class="c1">## 1 230.7219</span>
<span class="nf">mean_multiple_var</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">mpg</span><span class="p">,</span><span class="w"> </span><span class="n">disp</span><span class="p">,</span><span class="w"> </span><span class="n">qsec</span><span class="p">))</span><span class="w"> </span>
<span class="c1">##        mpg     disp     qsec</span>
<span class="c1">## 1 20.09062 230.7219 17.84875</span>
</code></pre></div>

<p>Si nous souhaitons que l'utilisateur entre un vecteur de chaînes de caractères, cela fonctionne aussi car <strong>across utilise la tidyselection</strong> qui tolère les appels aux vecteurs de chaînes de caractères. Il faut juste l'encapsuler dans une fonction appropriée, ici <code>all_of()</code> pour sélectionner tous les éléments du vecteur :  </p>
<div class="highlight"><pre><span></span><code><span class="n">mean_multiple_var2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">all_of</span><span class="p">(</span><span class="n">vars_mean</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">))</span>
<span class="p">}</span>
<span class="nf">mean_multiple_var2</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;mpg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;disp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qsec&quot;</span><span class="p">))</span><span class="w"> </span>
<span class="c1">##        mpg     disp     qsec</span>
<span class="c1">## 1 20.09062 230.7219 17.84875</span>
</code></pre></div>

<p>Notez qu'avec <code>any_of()</code>, on autorise l'utilisateur à entre <strong>des noms de colonnes n'existant pas dans le dataframe</strong>. Ils sont alors juste écartés de la sélection, sans que cela génère des erreurs :  </p>
<div class="highlight"><pre><span></span><code><span class="n">mean_multiple_var3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">any_of</span><span class="p">(</span><span class="n">vars_mean</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">))</span>
<span class="p">}</span>
<span class="nf">mean_multiple_var3</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Sepal.Length&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sepal.Width&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mpg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;disp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qsec&quot;</span><span class="p">))</span><span class="w"> </span>
<span class="c1">##        mpg     disp     qsec</span>
<span class="c1">## 1 20.09062 230.7219 17.84875</span>
</code></pre></div>

<p>Enfin, on peut utiliser l'argument <code>.names</code> de la fonction <code>across</code> pour permettre un <strong>renommage des variables au souhait de l'utilisateur</strong> :  </p>
<div class="highlight"><pre><span></span><code><span class="n">mean_multiple_var2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="p">,</span><span class="w"> </span><span class="n">prefixe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mean&quot;</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">all_of</span><span class="p">(</span><span class="n">vars_mean</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;{prefixe}_{.col}&quot;</span><span class="p">))</span>
<span class="p">}</span>
<span class="nf">mean_multiple_var2</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">vars_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;mpg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;disp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;qsec&quot;</span><span class="p">))</span><span class="w"> </span>
<span class="c1">##   mean_mpg mean_disp mean_qsec</span>
<span class="c1">## 1 20.09062  230.7219  17.84875</span>
</code></pre></div>

<p>Dans cette version, l'utilisateur peut <strong>paramétrer le préfixe qu'il souhaite</strong>, grâce à l'utilisation de la syntaxe propre au <a href="https://glue.tidyverse.org/">package <code>glue</code></a>. Notez l'utilisation de <code>.col</code>, interne à <code>across()</code>, pour faire référence au nom de la variable.   </p>
<h2 id="utilisation-de-pick-et">Utilisation de <code>pick</code> et <code>...</code></h2>
<p><code>pick()</code> (à partir de dplyr &gt;= 1.1.4) permet de sélectionner un nombre indéterminé de paramètres dans les fonctions du type <code>group_by()</code>, <code>select()</code>...c'est-à-dire les fonctions permettant de sélectionner un sous-ensemble de la base. C'est l'équivalent de <code>across()</code> pour les fonctions portant sur toute la base et non sur chacune des colonnes. Par exemple, la fonction suivante permet de grouper par des variables du choix de l'utilisateur et de sortir les moyennes de toutes les variables numériques :  </p>
<div class="highlight"><pre><span></span><code><span class="n">my_group_by</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">vars_group</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nf">group_by</span><span class="p">(</span><span class="nf">pick</span><span class="p">({{</span><span class="w"> </span><span class="n">vars_group</span><span class="w"> </span><span class="p">}}))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mean_{.col}&quot;</span><span class="p">))</span>
<span class="p">}</span>
<span class="nf">my_group_by</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">vars_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">am</span><span class="p">,</span><span class="w"> </span><span class="n">cyl</span><span class="p">))</span>
<span class="c1">## `summarise()` has grouped output by &#39;am&#39;. You can override using the `.groups`</span>
<span class="c1">## argument.</span>
<span class="c1">## # A tibble: 6 × 11</span>
<span class="c1">## # Groups:   am [2]</span>
<span class="c1">##      am   cyl mean_mpg mean_disp mean_hp mean_drat mean_wt mean_qsec mean_vs</span>
<span class="c1">##   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="c1">## 1     0     4     22.9     136.     84.7      3.77    2.94      21.0   1    </span>
<span class="c1">## 2     0     6     19.1     205.    115.       3.42    3.39      19.2   1    </span>
<span class="c1">## 3     0     8     15.0     358.    194.       3.12    4.10      17.1   0    </span>
<span class="c1">## 4     1     4     28.1      93.6    81.9      4.18    2.04      18.4   0.875</span>
<span class="c1">## 5     1     6     20.6     155     132.       3.81    2.76      16.3   0    </span>
<span class="c1">## 6     1     8     15.4     326     300.       3.88    3.37      14.6   0    </span>
<span class="c1">## # ℹ 2 more variables: mean_gear &lt;dbl&gt;, mean_carb &lt;dbl&gt;</span>
</code></pre></div>

<p>Comme pour <code>across</code>, vous pouvez aussi utiliser les verbes de la tidyselection : <code>all_of</code>, <code>any_of</code>, <code>starts_with</code>, etc...  </p>
<p>Enfin, il est possible d'utiliser la syntaxe <code>...</code>, de la manière suivante :  </p>
<div class="highlight"><pre><span></span><code><span class="n">my_group_by</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kc">...</span><span class="p">){</span>
<span class="w">  </span><span class="n">data</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nf">group_by</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mean_{.col}&quot;</span><span class="p">))</span>
<span class="p">}</span>
<span class="nf">my_group_by</span><span class="p">(</span><span class="n">mtcars</span><span class="p">,</span><span class="w"> </span><span class="n">am</span><span class="p">,</span><span class="w"> </span><span class="n">cyl</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="c1">## `summarise()` has grouped output by &#39;am&#39;. You can override using the `.groups`</span>
<span class="c1">## argument.</span>
<span class="c1">## # A tibble: 3 × 11</span>
<span class="c1">## # Groups:   am [1]</span>
<span class="c1">##      am   cyl mean_mpg mean_disp mean_hp mean_drat mean_wt mean_qsec mean_vs</span>
<span class="c1">##   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="c1">## 1     0     4     22.9      136.    84.7      3.77    2.94      21.0       1</span>
<span class="c1">## 2     0     6     19.1      205.   115.       3.42    3.39      19.2       1</span>
<span class="c1">## 3     0     8     15.0      358.   194.       3.12    4.10      17.1       0</span>
<span class="c1">## # ℹ 2 more variables: mean_gear &lt;dbl&gt;, mean_carb &lt;dbl&gt;</span>
</code></pre></div>

<p>Cette notation a l'avantage d'être très simple et flexible : on peut définir à la place des <code>...</code> autant de paramètres différents que l'on veut. Mais elle ne permet pas de différencier deux groupes de paramètres différents, si l'on veut par exemple définir d'une part des variables sur lesquels grouper, et d'autre des variables sur lesquels sélectionner.       </p>
<h1 id="conclusion">Conclusion</h1>
<p>Le <code>tidyverse</code>, c'est donc plein d'astuces pour rendre le code très facile à écrire et à lire, mais cela implique quelques étapes supplémentaires quand on veut coder ses propres fonctions. On espère que cet article vous aura aidés à y voir plus clair. Pour creuser le sujet, vous pouvez vous référer à la page <a href="https://dplyr.tidyverse.org/articles/programming.html#user-supplied-data">Programming with dplyr</a> sur la documentation officielle de <code>dplyr</code>. Vous pouvez également consulter, sur le site de <code>rlang</code>, les pages <a href="https://rlang.r-lib.org/reference/glue-operators.html">Name injection</a> et <a href="https://rlang.r-lib.org/reference/topic-data-mask-programming.html">Data mask programming patterns</a>.  </p>
<p>C'est la fin de cet article! N'hésitez pas à <a href="https://www.statoscop.fr">visiter notre site</a> et à nous suivre sur <a href="https://twitter.com/stato_scop">Twitter</a> et <a href="https://www.linkedin.com/company/statoscop">Linkedin</a>. Pour retrouver l'ensemble du code ayant servi à générer cette note, vous pouvez vous rendre sur le <a href="https://github.com/Statoscop/notebooks-blog">github de Statoscop</a>.   </p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Coder des fonctions dans le tidyverse&amp;url=https://blog.statoscop.fr/coder-des-fonctions-dans-le-tidyverse.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://blog.statoscop.fr/tag/r.html">R</a><a href="https://blog.statoscop.fr/tag/rstats.html">Rstats</a><a href="https://blog.statoscop.fr/tag/tidyverse.html">tidyverse</a><a href="https://blog.statoscop.fr/tag/dplyr.html">dplyr</a><a href="https://blog.statoscop.fr/tag/across.html">across</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
    
    <!-- Footer-->
    <footer class="footer py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 text-lg-left"> © Statoscop</div>
                <div class="col-lg-4 my-3 my-lg-0">
                    <a class="btn btn-dark btn-social mx-2" href="https://twitter.com/stato_scop" target="_blank"><i class="fab fa-twitter"></i></a>
                </div>
                <div class="col-lg-4 text-lg-left"> 
                    Blog publié avec <a class="js-scroll-trigger text-info" href="https://docs.getpelican.com/en/latest/"  target="_blank">Pelican</a> et
                     déployé sur <a class="js-scroll-trigger text-info" href="https://pages.github.com/"  target="_blank">Github Pages</a>.
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap core JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
    <!-- Third party plugin JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script type="text/javascript" src="https://blog.statoscop.fr/themes/statoscop/static/js/script.js"></script>

  </body>
</html>
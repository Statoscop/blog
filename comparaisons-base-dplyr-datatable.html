<!DOCTYPE html>
<html lang="fr">

<head>
<title>Comparaisons base R, dplyr et data.table</title>    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Le blog statistiques et data science de la coopérative Statoscop" />
  <meta name="author" content="" />

  <!-- Font Awesome icons (free version)-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <!-- Google fonts-->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />



  <!-- <title>Le blog de Statoscop - études de cas en R et Python</title> -->
  <link rel="icon" type="image/x-icon" href="https://blog.statoscop.fr/themes/statoscop/static/images/favicon-v1.ico" />


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="https://blog.statoscop.fr/comparaisons-base-dplyr-datatable.html" rel="canonical" />
  <!-- Feed -->
        <link href="https://blog.statoscop.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Full Atom Feed" />
          <link href="https://blog.statoscop.fr/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Categories Atom Feed" />

  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style.css" type="text/css" rel="stylesheet" />-->
  <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style-site.css" type="text/css" rel="stylesheet" /> 
  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style_fusion.css" type="text/css" rel="stylesheet" /> -->
  <!-- Code highlight color scheme -->
      <link href="https://blog.statoscop.fr/themes/statoscop/static/css/code_blocks/github.css" rel="stylesheet">

  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!-- [if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  ![endif] -->



    <meta name="description" content="Comparaisons des temps d'exécution de base R, dplyr et data.table sur quelques cas d'étude">

    <meta name="author" content="Antoine">

    <meta name="tags" content="R">
    <meta name="tags" content="Rstats">
    <meta name="tags" content="dplyr">
    <meta name="tags" content="data.table">
    <meta name="tags" content="benchmark">




<!-- Open Graph -->
<meta property="og:site_name" content="Le blog"/>
<meta property="og:title" content="Comparaisons base R, dplyr et data.table"/>
<meta property="og:description" content="Comparaisons des temps d'exécution de base R, dplyr et data.table sur quelques cas d'étude"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://blog.statoscop.fr/comparaisons-base-dplyr-datatable.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-03-30 00:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://blog.statoscop.fr/author/antoine.html">
<meta property="article:section" content="R"/>
<meta property="article:tag" content="R"/>
<meta property="article:tag" content="Rstats"/>
<meta property="article:tag" content="dplyr"/>
<meta property="article:tag" content="data.table"/>
<meta property="article:tag" content="benchmark"/>
<meta property="og:image" content="https://blog.statoscop.fr/images/cover_1.png">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Comparaisons base R, dplyr et data.table",
  "headline": "Comparaisons base R, dplyr et data.table",
  "datePublished": "2021-03-30 00:00:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Antoine",
    "url": "https://blog.statoscop.fr/author/antoine.html"
  },
  "image": "https://blog.statoscop.fr/images/cover_1.png",
  "url": "https://blog.statoscop.fr/comparaisons-base-dplyr-datatable.html",
  "description": "Comparaisons des temps d'exécution de base R, dplyr et data.table sur quelques cas d'étude"
}
</script>
  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//matomo.statoscop.fr/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->

  

</head>
<!-- TODO : Body class -->
  <body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
      <div class="container">

        <a class="navbar-brand" href="https://statoscop.fr"><img src="https://blog.statoscop.fr/themes/statoscop/static/images/logo-statoscop-v1.png" alt="Statoscop.logo"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav text-uppercase ml-auto">
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger " href="https://statoscop.fr"> Accueil </a>
              </li>
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger " href="https://statoscop.fr/about"> À propos </a>
              </li>
              <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle font-weight-bold "
                  id="navbarDropdownMenuLink" aria-haspopup="true" aria-expanded="false"> Prestations </a>
                  <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                      <li><a class="dropdown-item" href="https://statoscop.fr/etudes">Conseils & études statistiques</a></li>
                      <li><a class="dropdown-item" href="https://statoscop.fr/recodages">Migrations de code & Recodages</a></li>
                      <li><a class="dropdown-item" href="https://statoscop.fr/formations">Formations</a></li>
                      <li><a class="dropdown-item" href="https://statoscop.fr/applis">Dashboards & Applications</a></li>
                  </ul>
              </li>
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger " href="https://statoscop.fr/contact">Contact</a>
              </li>
              <li class="nav-item font-weight-bold">
                  <a class="nav-link js-scroll-trigger active" href="https://blog.statoscop.fr/">Le blog</a>
              </li>
          </ul>
      </div>
      </div>
    </nav>
    


    <!-- Post content -->
    <main class="content" role="main">
      
      <div>
      </div>

      <article class="post">
        <div class="inner">




            <section class="post-content">
              <h1 class="post-title">Comparaisons base R, dplyr et data.table</h1>
                <!-- Le titres et meta infos-->
                <span class="post-meta">
                        <a href="https://blog.statoscop.fr/author/antoine.html">Antoine</a>
                    | <time datetime="mar. 30 mars 2021">mar. 30 mars 2021</time>
                </span>

                <!--Table des matieres
-->
                
                <div class="toc"><span class="toctitle">Dans cet article</span><ul>
<li><a href="#rappels-sur-dplyr-et-datatable">Rappels sur dplyr et data.table</a><ul>
<li><a href="#dplyr-et-le-tidyverse">dplyr et le tidyverse</a></li>
<li><a href="#datatable">Data.table</a></li>
<li><a href="#vitesses-dexecution">Vitesses d'exécution</a></li>
</ul>
</li>
<li><a href="#comparaisons-sur-une-etude-de-cas-simple">Comparaisons sur une étude de cas simple</a><ul>
<li><a href="#notre-etude-de-cas">Notre étude de cas</a></li>
<li><a href="#moyenne-des-retards-et-fusion-des-tables">Moyenne des retards et fusion des tables</a></li>
<li><a href="#comparaisons-des-vitesses-dexecution">Comparaisons des vitesses d'exécution</a></li>
</ul>
</li>
</ul>
</div>
<p>Cet article est une mise à jour de l'article du <a href="https://antoinesir.rbind.io/post/comparaisons-base-r-dplyr-data-table/" target="_blank">blog d'Antoine</a> réalisé en 2018. L'idée est de comparer les performances de trois alternatives dans R pour l'analyse de données : <br>
- l'utilisation des seules fonctions de base R<br>
- dplyr<br>
- data.table  </p>
<h1 id="rappels-sur-dplyr-et-datatable">Rappels sur dplyr et data.table</h1>
<p>On rappelle ici les principales caractéristiques de ces packages mais pour se former à leur utilisation on peut se référer au <a href="https://teaching.slmc.fr/perf/presentation_handout.pdf" target="_blank">cours de perfectionnement de Martin Chevalier</a>. Pour une exploration de ce qu'englobe le <code>tidyverse</code> et notamment une présentation des commandes de <code>dplyr</code>, vous pouvez jeter un oeil à <a href="https://juba.github.io/tidyverse/index.html" target="_blank">l'introduction à R et au tidyverse</a> de J. Barnier. Enfin pour data.table, on trouve des informations utiles sur le cours <a href="http://larmarange.github.io/analyse-R/manipulations-avancees-avec-data-table.html" target="_blank">Manipulations avancée avec data.table</a> de J. Larmarange et on vous conseille l'excellent article <a href="https://atrebas.github.io/post/2020-06-17-datatable-introduction/" target="_blank">a gentle introduction to data.table</a>.  </p>
<h2 id="dplyr-et-le-tidyverse">dplyr et le tidyverse</h2>
<p>Le <code>tidyverse</code> (contraction de "tidy" et "universe") est un concept initié par Hadley Wickham, chef statisticien de RStudio. Il regroupe un ensemble de packages utiles au traitement statistique et au nettoyage de bases de données. On va s'intéresser ici presque seulement au package <code>dplyr</code> (dont les instructions seront appliquées aux <code>tibbles</code>, un format de data.frame issu du <code>tidyverse</code>), mais vous pouvez parcourir les packages proposés dans le tidyverse sur <a href="https://www.tidyverse.org/" target="_blank">le site officiel</a>.  </p>
<p><code>dplyr</code> propose un ensemble d'opérations de traitement de données sous une syntaxe différente de celle utilisée dans les fonctions de base de R. Ce langage présente le double avantage d'être à la fois lisible pour quelqu'un habitué aux langages tels que SAS ou SQL et de proposer des fonctions optimisées qui présentent de bonnes performances en termes de temps d'exécution. La grammaire <code>dplyr</code> s'appuie en effet sur des fonctions au nom explicite :  </p>
<ul>
<li><code>mutate(data, newvar1=fonction(var1,var2...))</code> et <code>transmute(data, newvar1=fonction(var1,var2...))</code> créent de nouvelles variables</li>
<li><code>filter(data, condition)</code> sélectionne au sein d'une table certaines observations, à la manière de <code>where</code> dans SAS.</li>
<li><code>arrange(data, var1, descending var2,...)</code> trie une base selon une ou plusieurs variables (l'équivalent d'une <code>proc sort</code>).</li>
<li><code>select(data, var1 : varX)</code> sélectionne certaines variables dans une base, à la manière de <code>keep</code> dans SAS. </li>
<li><code>summarise(data, newvar1=mean(var1), newvar2=sum(var2))</code> réalise toute sorte d'opérations statistiques sur une table.</li>
<li><code>group_by(data, var)</code> regroupe une table par une variable</li>
<li>et bien d'autres...  </li>
</ul>
<p>Un aspect pratique de ce langage est que toutes ces opérations peuvent être chaînées à l'aide de l'opérateur <code>%&gt;%</code> ("pipe" en anglais, issu du package <code>magrittr</code>) dont la syntaxe est la suivante : <code>data %&gt;% fonction(...)</code> est équivalent à <code>fonction(data, ...)</code>. Cette syntaxe permet de chaîner un grand nombre d'opérations sur une base commune, en limitant le nombre de fois où l'on écrit des tables intermédiaires tout en conservant une grande lisibilité du code. Ce petit exemple vous en convaincra peut-être :  </p>
<div class="highlight"><pre><span></span><code><span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="c1"># on crée un data frame avec 100 lignes, </span>
<span class="c1"># chaque individu appartenant à un des 50 groupes</span>
<span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">id1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">),</span><span class="w"> </span><span class="n">idgpe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="m">50</span><span class="p">),</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># on y applique les instructions de dplyr</span>
<span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">as_tibble</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="m">100</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">group_by</span><span class="p">(</span><span class="n">idgpe</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="n">var_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">var</span><span class="p">))</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">output_tibble</span>
</code></pre></div>

<p>Un regard peu habitué contesterait peut-être l'aspect très lisible de l'instruction, mais ça l'est réellement. Le déroulé est le suivant :  </p>
<p>1) on transforme notre data.frame en tibble (pour rappel : format optimisé de data.frame pour dplyr) avec <code>as_tibble</code><br>
2) on crée une variable <code>var</code> avec <code>mutate</code><br>
3) on agrège par  <code>idgpe</code> avec <code>group_by</code> <br>
4) on calcule la moyenne de <code>var</code> avec <code>summarise</code>, que l'on stocke dans <code>var_mean</code>. Comme cette instruction suit un group_by, elle est réalisée à l'intérieur de chaque groupe (défini par <code>idgpe</code>), sinon elle aurait été réalisé sur l'ensemble de la table.    </p>
<p>Tout cela est stocké dans une table output_tibble, qui est ainsi un tibble agrégé par <code>idgpe</code> et qui a donc 50 lignes. L'intérêt de ce chaînage est qu'il permet une économie de code et d'écriture d'éventuelles tables intermédiaires.  </p>
<h2 id="datatable">Data.table</h2>
<p>Le package <code>data.table</code> ne prétend pas, contrairement au <code>tidyverse</code>, proposer une syntaxe concurrente à base R mais enrichir celle-ci. Il est axé autour d'un nouveau format d'objet, le data.table, qui est un type de data.frame qui permet une utilisation optimisée de l'opérateur <code>[</code>.<br>
Tout data.frame peut être converti en data.table grâce à la fonction <code>as.data.table</code>, ou, de manière plus optimale pour l'utilisation de la mémoire, grâce à la fonction <code>setDT</code> qui permet de directement transformer la nature de l'objet sans avoir à en écrire un autre. Il est important d'avoir en tête qu'un data.frame converti en data.table conserve les caractéristiques d'un data.frame. Cependant, l'opérateur <code>[</code> appliqué au data.table change de signification et devient :  </p>
<div class="highlight"><pre><span></span><code><span class="n">DT</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">by</span><span class="p">]</span>
</code></pre></div>

<p>Avec <code>i</code> qui permet de sélectionner des observations (sans avoir besoin de répéter le nom de la base dans laquelle on se trouve), <code>j</code> qui permet de créer ou sélectionner des variables et <code>by</code> de regrouper les traitement selon les modalités d'une variable définie. Comme dans <code>dplyr</code>, il est possible de chaîner les opérations réalisées comme le montre l'exemple suivant, qui reprend le même cas de figure que celui illustrant le package <code>dplyr</code> :  </p>
<div class="highlight"><pre><span></span><code><span class="nf">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span><span class="w"> </span>
<span class="c1"># on convertit notre data frame précédemment créé en data.table</span>
<span class="n">dt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.data.table</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># on y applique les même instructions</span>
<span class="n">dt</span><span class="p">[,</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">var_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="nf">rnorm</span><span class="p">(</span><span class="m">100</span><span class="p">))),</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">idgpe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idgpe</span><span class="p">)]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">output_dt</span>
</code></pre></div>

<p>Le fait de renseigner les variables au sein de <code>list()</code> permet d'avoir une table en sortie au niveau de <code>idgpe</code> (donc 50 observations), sans cela la variable est bien moyennée par groupe mais la table en sortie est toujours au niveau <code>id1</code> (100 observations).   </p>
<h2 id="vitesses-dexecution">Vitesses d'exécution</h2>
<p>Voilà donc pour les présentations! Allez, on montre le résultat d'un petit <code>microbenchmark</code> des deux juste pour voir : </p>
<table class="dataframe">
<caption>Temps d'exécution en microsecondes</caption>
<thead>
    <tr><th scope=col>expr</th><th scope=col>lq</th><th scope=col>mean</th><th scope=col>uq</th><th scope=col>neval</th></tr>
</thead>
<tbody>
    <tr><td>dplyr     </td><td>9.79270</td><td>13.23297</td><td>14.367579</td><td>100</td></tr>
    <tr><td>data.table</td><td>1.40644</td><td> 2.13729</td><td> 2.546176</td><td>100</td></tr>
</tbody>
</table>

<p>Sur cet exemple, on voit un avantage clair à data.table! Mais on est sur une toute petite table en entrée. On va essayer de se rapprocher de cas plus concrets en s'intéressant à un exemple sur des bases plus importantes.  </p>
<h1 id="comparaisons-sur-une-etude-de-cas-simple">Comparaisons sur une étude de cas simple</h1>
<p>Les avantages et inconvénients de ces deux packages sont à l'origine de nombreux débats. Vous pouvez vous en convaincre en suivant <a href="https://stackoverflow.com/questions/21435339/data-table-vs-dplyr-can-one-do-something-well-the-other-cant-or-does-poorly" target="_blank">cette discussion sur stackoverflow</a>. On peut quand même dégager deux compromis :   </p>
<ul>
<li>Le choix de l'un ou l'autre des packages dépend beaucoup de ce que l'on va en faire (types d'analyses, taille des données, profils des utilisateurs du code...).   </li>
<li>Les deux packages sont plus intéressants que base R pour l'analyse de données, que ce soit en termes de facilité d'écriture ou de performances.   </li>
</ul>
<p>Pour ce deuxième point, on va essayer de s'en convaincre ensemble avec ce petit exemple.</p>
<h2 id="notre-etude-de-cas">Notre étude de cas</h2>
<p>Pour cet exemple, on utilise les données du package de Hadley Wickham que l'on trouve dans <code>nycflights13</code>. En particulier, la base <code>flights</code> donne toutes les heures de départ et d'arrivée selon les aéroports de départ et d'arrivée ainsi que les retards au départ et à l'arrivée. La base <code>weather</code> donne elle des indications météo, heure par heure, dans chaque aéroport. <br>
Commençons par charger nos packages (n'oubliez pas de faire <code>install.packages("nom_pck")</code> avant si vous ne l'avez jamais fait) et nos données : </p>
<div class="highlight"><pre><span></span><code><span class="c1"># Les packages nécessaires</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w"> </span><span class="c1"># Regroupe différents packages, voir https://www.tidyverse.org/ </span>
<span class="nf">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">microbenchmark</span><span class="p">)</span><span class="w"> </span><span class="c1"># Pour les calculs de vitesse d&#39;exécution</span>
<span class="nf">library</span><span class="p">(</span><span class="n">nycflights13</span><span class="p">)</span><span class="w"> </span><span class="c1"># Pour les données</span>

<span class="c1"># data.table pour tests avec data.table</span>
<span class="n">flightsdt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.data.table</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span>
<span class="n">weatherdt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.data.table</span><span class="p">(</span><span class="n">weather</span><span class="p">)</span>
</code></pre></div>

<h2 id="moyenne-des-retards-et-fusion-des-tables">Moyenne des retards et fusion des tables</h2>
<p>Un rapide examen des bases vous montre que la première étape avant toute analyse est comme souvent de regrouper les éléments de flights par heure et aéroport de départ pour pouvoir les fusionner avec la table weather, qui donnent les indications météo minute par minute. On écrit cette instruction de  3 manières différentes :  </p>
<p><strong>En base R</strong>  </p>
<div class="highlight"><pre><span></span><code><span class="n">flights_time_hour</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">aggregate.data.frame</span><span class="p">(</span>
<span class="w">    </span><span class="nf">list</span><span class="p">(</span><span class="n">arr_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flights</span><span class="o">$</span><span class="n">arr_delay</span><span class="p">,</span><span class="w"> </span>
<span class="w">         </span><span class="n">dep_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flights</span><span class="o">$</span><span class="n">dep_delay</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="nf">list</span><span class="p">(</span><span class="n">time_hour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flights</span><span class="o">$</span><span class="n">time_hour</span><span class="p">,</span><span class="w"> </span>
<span class="w">         </span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flights</span><span class="o">$</span><span class="n">origin</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="n">mean</span><span class="p">)</span>
<span class="n">output_base</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">weather</span><span class="p">,</span><span class="w"> </span><span class="n">flights_time_hour</span><span class="p">,</span><span class="w"> </span>
<span class="w">                     </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;time_hour&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;origin&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">sort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span>
</code></pre></div>

<p><strong>En dplyr</strong>  </p>
<div class="highlight"><pre><span></span><code><span class="n">flights</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">group_by</span><span class="p">(</span><span class="n">time_hour</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">summarise</span><span class="p">(</span><span class="n">arr_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">arr_delay</span><span class="p">),</span>
<span class="w">            </span><span class="n">dep_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">inner_join</span><span class="p">(</span><span class="n">weather</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;time_hour&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;origin&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">output_dplyr</span><span class="w"> </span>
</code></pre></div>

<p><strong>En data.table</strong>  </p>
<div class="highlight"><pre><span></span><code><span class="n">output_DT</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">flightsdt</span><span class="p">[,</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">arr_perc_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">arr_delay</span><span class="p">),</span>
<span class="w">                                    </span><span class="n">dep_perc_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">)),</span><span class="w"> </span>
<span class="w">                             </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;time_hour&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;origin&quot;</span><span class="p">)],</span><span class="w"> </span>
<span class="w">                   </span><span class="n">weatherdt</span><span class="p">,</span><span class="w"> </span>
<span class="w">                   </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;time_hour&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;origin&quot;</span><span class="p">))</span>
</code></pre></div>

<p>On utilise la fonction <code>merge</code> plutôt que <code>DT1[DT2, on = c("time_hour", "origin"), nomatch = 0]</code> car on a constaté qu'elle était plus rapide, conformément à ce que montre bien cet <a href="https://jozefhajnala.gitlab.io/r/r006-merge/" target="_blank">article du Jozef's Rblog</a>.  </p>
<h2 id="comparaisons-des-vitesses-dexecution">Comparaisons des vitesses d'exécution</h2>
<p>Chacun jugera de la lisibilité de chacune de ces instructions, qui font toutes la même chose, car c'est finalement assez subjectif. On donne ici les résultats d'un <code>microbenchmark</code> de ces instructions : </p>
<table class="dataframe">
<caption>Temps d'exécution en millisecondes</caption>
<thead>
    <tr><th scope=col>expr</th><th scope=col>lq</th><th scope=col>mean</th><th scope=col>uq</th><th scope=col>neval</th></tr>
</thead>
<tbody>
    <tr><td>Base </td><td>1182.33161</td><td>1396.52780</td><td>1559.42968</td><td>10</td></tr>
    <tr><td>dplyr</td><td> 223.45642</td><td> 313.16457</td><td> 360.95388</td><td>10</td></tr>
    <tr><td>DT   </td><td>  22.83487</td><td>  24.68264</td><td>  26.32068</td><td>10</td></tr>
</tbody>
</table>

<p>Les résultats sont très nettement en faveur des packages <code>dplyr</code> et <code>data.table</code>. Ce dernier est même assez largement le plus rapide, son avantage s'étant accru depuis la première version de cette article. Sans doute existe-t-il des moyens de plus optimiser l'instruction en base R, mais là n'est pas vraiment la question. On voit qu'avec une syntaxe simple et lisible, <code>dplyr</code> et <code>data.table</code> font beaucoup mieux en termes de vitesse d'exécution que les fonctions de base R. </p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Comparaisons base R, dplyr et data.table&amp;url=https://blog.statoscop.fr/comparaisons-base-dplyr-datatable.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://blog.statoscop.fr/tag/r.html">R</a><a href="https://blog.statoscop.fr/tag/rstats.html">Rstats</a><a href="https://blog.statoscop.fr/tag/dplyr.html">dplyr</a><a href="https://blog.statoscop.fr/tag/datatable.html">data.table</a><a href="https://blog.statoscop.fr/tag/benchmark.html">benchmark</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
    
        <!-- Footer-->
        <footer class="footer py-4">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-4 text-lg-left"> © Statoscop<br> 3 rue Jacques Roudil 31300 Toulouse</div>
                    <div class="col-lg-4 my-3 my-lg-0">
                        <a class="btn btn-dark btn-social mx-2" href="https://fr.linkedin.com/company/statoscop" target="_blank"><i class="fa-brands fa-linkedin-in"></i></a>
                    </div>
                    <div class="col-lg-4 text-lg-left"> 
                        Blog publié avec <a class="js-scroll-trigger text-info" href="https://docs.getpelican.com/en/latest/"  target="_blank">Pelican</a> et
                        déployé sur <a class="js-scroll-trigger text-info" href="https://pages.github.com/"  target="_blank">Github Pages</a>.
                    </div>
                </div>
            </div>
        </footer>

    <!-- Bootstrap core JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
    <!-- Third party plugin JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script type="text/javascript" src="https://blog.statoscop.fr/themes/statoscop/static/js/script.js"></script>

  </body>
</html>
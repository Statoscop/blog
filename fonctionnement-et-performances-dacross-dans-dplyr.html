<!DOCTYPE html>
<html lang="fr">

<head>
<title>Fonctionnement et performances d'across dans dplyr</title>    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Statisticiens à Toulouse et Bayonne organisés en coopérative pour vous accompagner dans l'analyse de vos données" />
  <meta name="author" content="" />

  <!-- Font Awesome icons (free version)-->
  <script src="https://use.fontawesome.com/releases/v5.13.0/js/all.js" crossorigin="anonymous"></script>
  <!-- Google fonts-->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />



  <!-- <title>Le blog de Statoscop - études de cas en R et Python</title> -->
  <link rel="icon" type="image/x-icon" href="https://blog.statoscop.fr/themes/statoscop/static/images/favicon-v1.ico" />


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="https://blog.statoscop.fr/fonctionnement-et-performances-dacross-dans-dplyr.html" rel="canonical" />
  <!-- Feed -->
        <link href="https://blog.statoscop.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Full Atom Feed" />
          <link href="https://blog.statoscop.fr/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="Le blog Categories Atom Feed" />

  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style.css" type="text/css" rel="stylesheet" />-->
  <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style-site.css" type="text/css" rel="stylesheet" /> 
  <!-- <link href="https://blog.statoscop.fr/themes/statoscop/static/css/style_fusion.css" type="text/css" rel="stylesheet" /> -->
  <!-- Code highlight color scheme -->
      <link href="https://blog.statoscop.fr/themes/statoscop/static/css/code_blocks/github.css" rel="stylesheet">

  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!-- [if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  ![endif] -->



    <meta name="description" content="Mise à jour de l'évaluation des performances du verbe across dans dplyr version 1.0.6">

    <meta name="author" content="Antoine">

    <meta name="tags" content="R">
    <meta name="tags" content="Rstats">
    <meta name="tags" content="dplyr">
    <meta name="tags" content="across">
    <meta name="tags" content="tidyverse">




<!-- Open Graph -->
<meta property="og:site_name" content="Le blog"/>
<meta property="og:title" content="Fonctionnement et performances d'across dans dplyr"/>
<meta property="og:description" content="Mise à jour de l'évaluation des performances du verbe across dans dplyr version 1.0.6"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://blog.statoscop.fr/fonctionnement-et-performances-dacross-dans-dplyr.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-06-02 00:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://blog.statoscop.fr/author/antoine.html">
<meta property="article:section" content="R"/>
<meta property="article:tag" content="R"/>
<meta property="article:tag" content="Rstats"/>
<meta property="article:tag" content="dplyr"/>
<meta property="article:tag" content="across"/>
<meta property="article:tag" content="tidyverse"/>
<meta property="og:image" content="https://blog.statoscop.fr/images/cover_5.png">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Fonctionnement et performances d'across dans dplyr",
  "headline": "Fonctionnement et performances d'across dans dplyr",
  "datePublished": "2021-06-02 00:00:00+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Antoine",
    "url": "https://blog.statoscop.fr/author/antoine.html"
  },
  "image": "https://blog.statoscop.fr/images/cover_5.png",
  "url": "https://blog.statoscop.fr/fonctionnement-et-performances-dacross-dans-dplyr.html",
  "description": "Mise à jour de l'évaluation des performances du verbe across dans dplyr version 1.0.6"
}
</script>
  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//env-7278291.jcloud-ver-jpe.ik-server.com/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->
  

</head>
<!-- TODO : Body class -->
  <body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
      <div class="container">

        <a class="navbar-brand" href="https://statoscop.fr"><img src="https://blog.statoscop.fr/themes/statoscop/static/images/logo-statoscop-v1.png" alt="Statoscop.logo"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav text-uppercase ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle font-weight-bold "
                    href="https://statoscop.fr" id="navbarDropdownMenuLink" aria-haspopup="true" aria-expanded="false"> Accueil </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <li><a class="dropdown-item" href="https://statoscop.fr#services">Vos besoins</a></li>
                        <li><a class="dropdown-item" href="https://statoscop.fr#portfolio">Nos missions</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle font-weight-bold "
                    href="https://statoscop.fr/about" id="navbarDropdownMenuLink" aria-haspopup="true" aria-expanded="false"> Qui sommes-nous&#8239;? </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <li><a class="dropdown-item" href="https://statoscop.fr/about#coop">La coopérative</a></li>
                        <li><a class="dropdown-item" href="https://statoscop.fr/about#expertise">Notre expertise</a></li>
                        <li><a class="dropdown-item" href="https://statoscop.fr/about#team">L'équipe</a></li>
                    </ul>
                </li>
                <li class="nav-item font-weight-bold"><a class="nav-link js-scroll-trigger " href="https://statoscop.fr/contact">Contact</a></li>
                <li class="nav-item font-weight-bold"><a class="nav-link js-scroll-trigger active" href="https://blog.statoscop.fr/">Le blog</a></li>
            </ul>
        </div>
      </div>
    </nav>
    


    <!-- Post content -->
    <main class="content" role="main">
      
      <div>
      </div>

      <article class="post">
        <div class="inner">




            <section class="post-content">
              <h1 class="post-title">Fonctionnement et performances d'across dans dplyr</h1>
                <!-- Le titres et meta infos-->
                <span class="post-meta">
                        <a href="https://blog.statoscop.fr/author/antoine.html">Antoine</a>
                    | <time datetime="mer. 02 juin 2021">mer. 02 juin 2021</time>
                </span>

                <!--Table des matieres
-->
                
                <div class="toc"><span class="toctitle">Table des matières</span><ul>
<li><a href="#across-ca-marche-comment">across(), ça marche comment?</a><ul>
<li><a href="#syntaxe-de-base">Syntaxe de base</a></li>
<li><a href="#selection-avec-des-conditions">Sélection avec des conditions</a></li>
<li><a href="#selection-a-partir-du-nom">Sélection à partir du nom</a></li>
<li><a href="#autres-proprietes">Autres propriétés</a></li>
</ul>
</li>
<li><a href="#across-ca-tourne-comment">across(), ça tourne comment?</a><ul>
<li><a href="#instructions-sur-lesquelles-on-compare-les-methodes">Instructions sur lesquelles on compare les méthodes</a></li>
<li><a href="#resultats-de-la-version-106">Résultats de la version 1.0.6</a></li>
<li><a href="#resultats-de-la-version-100">Résultats de la version 1.0.0</a></li>
</ul>
</li>
</ul>
</div>
<p>A la sortie de l'été dernier, j'ai réalisé une <a href="https://antoinesir.rbind.io/post/fonctionnement-de-across-dans-dplyr/" target="_blank">note sur mon blog personnel</a> sur un élément important d'une mise à jour majeure de dplyr : <code>across()</code>, un nouveau verbe pour réaliser des opérations sur plusieurs colonnes. Dans cette note, on utilisait la version <code>1.0.2</code> de <code>dplyr</code> et on comparait <code>across</code> aux verbes équivalents que cela devait remplacer (fonctions indexées par <code>_at</code>, <code>_if</code> et <code>_all</code>) . On constatait une moins bonne performance d' <code>across</code> en termes de temps d'exécution. Cet élément était bien connu des développeurs de RStudio et a été constamment pris en compte dans les différentes mises à jour. On reprend ici cette note en la mettant à jour avec la version <code>1.0.6</code> de <code>dplyr</code> disponible à ce jour pour voir où se place désormais <code>across</code> en termes de temps d'exécution.</p>
<p>Si vous voulez balayer plus largement les différents éléments de la mise à jour de <code>dplyr</code>, vous pouvez vous rendre sur <a href="https://www.tidyverse.org/blog/2020/06/dplyr-1-0-0/" target="_blank">le site du tidyverse</a> (en anglais) ou sur <a href="https://thinkr.fr/hey-quoi-de-neuf-dplyr-le-point-sur-la-v1/#La_fonction_de_calcul_avec_conditions_sur_les_variables_across()" target="_blank">cet article du blog de ThinkR</a> (en français) qui en présentent les changements majeurs. </p>
<h1 id="across-ca-marche-comment"><code>across()</code>, ça marche comment?</h1>
<h2 id="syntaxe-de-base">Syntaxe de base</h2>
<p>Le verbe <code>across()</code> vise à remplacer toutes les fonctions suffixées par <code>_if</code>, <code>_at</code> et <code>_all</code>. Il regroupe ces méthodes dans une seule et permet ainsi de les associer, ce qui n'était pas possible avant. Il s'utilise dans <code>mutate</code> et <code>summarise</code>. La syntaxe associée à ce verbe est la suivante :   </p>
<div class="highlight"><pre><span></span><code><span class="nf">across</span><span class="p">(</span><span class="n">.cols</span><span class="p">,</span><span class="w"> </span><span class="n">.fns</span><span class="p">)</span>
</code></pre></div>

<p>Dans laquelle :<br>
 - Les colonnes <code>.cols</code> peuvent être sélectionnées en utilisant la même syntaxe que pour la méthode <code>vars()</code> (nom des variables, <code>starts_with</code>, <code>end_with</code>, <code>contains</code>,...), mais aussi avec des conditions rentrées dans <code>where()</code> qui sélectionneront de la même manière que le faisaient les fonctions suffixées par <code>_if</code>.<br>
 - La fonction <code>.fns</code> est définie comme auparavant (le nom de la fonction ou sa définition "à la volée" avec <code>~ my_fun(.)</code>).  </p>
<p>On présente quelques exemples en utilisant la table <code>penguins</code> promue par <a href="https://github.com/allisonhorst/palmerpenguins" target="_blank">Allison Horst</a> pour remplacer l'usage de la table iris. Vous pouvez l'obtenir depuis le package <code>palmerpenguins</code> sur le CRAN.  </p>
<h2 id="selection-avec-des-conditions">Sélection avec des conditions</h2>
<p>À partir de cette table, l'instruction visant à sortir la moyenne de toutes les variables numériques s'écrivait auparavant :  </p>
<div class="highlight"><pre><span></span><code><span class="n">penguins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise_if</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## # A tibble: 1 x 5</span>
<span class="c1">##   bill_length_mm bill_depth_mm flipper_length_mm body_mass_g  year</span>
<span class="c1">##            &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="c1">## 1           43.9          17.2              201.       4202. 2008.</span>
</code></pre></div>

<p>Elle se réécrit avec <code>across()</code> en utilisant <code>where()</code> :  </p>
<div class="highlight"><pre><span></span><code><span class="n">penguins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span>
<span class="c1">## # A tibble: 1 x 5</span>
<span class="c1">##   bill_length_mm bill_depth_mm flipper_length_mm body_mass_g  year</span>
<span class="c1">##            &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="c1">## 1           43.9          17.2              201.       4202. 2008.</span>
</code></pre></div>

<h2 id="selection-a-partir-du-nom">Sélection à partir du nom</h2>
<p>Si l'on souhaite sélectionner à partir du nom des variables, la nouvelle syntaxe est la suivante :  </p>
<div class="highlight"><pre><span></span><code><span class="c1"># Ancienne version</span>
<span class="n">penguins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="nf">matches</span><span class="p">(</span><span class="s">&quot;bill*|flipper*&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## # A tibble: 1 x 3</span>
<span class="c1">##   bill_length_mm bill_depth_mm flipper_length_mm</span>
<span class="c1">##            &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;</span>
<span class="c1">## 1           43.9          17.2              201.</span>

<span class="c1"># Avec across()</span>
<span class="n">penguins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">matches</span><span class="p">(</span><span class="s">&quot;bill*|flipper*&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span>
<span class="c1">## # A tibble: 1 x 3</span>
<span class="c1">##   bill_length_mm bill_depth_mm flipper_length_mm</span>
<span class="c1">##            &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;</span>
<span class="c1">## 1           43.9          17.2              201.</span>
</code></pre></div>

<h2 id="autres-proprietes">Autres propriétés</h2>
<p>On note également qu'on peut combiner dorénavant les sélections sur les types des colonnes et sur leur nom dans une seule instruction <code>across()</code>, ce qui n'était pas possible avant. Pour enlever les années des moyennes numériques, on peut par exemple écrire :   </p>
<div class="highlight"><pre><span></span><code><span class="n">penguins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">-</span><span class="nf">contains</span><span class="p">(</span><span class="s">&quot;year&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span>
<span class="c1">## # A tibble: 1 x 4</span>
<span class="c1">##   bill_length_mm bill_depth_mm flipper_length_mm body_mass_g</span>
<span class="c1">##            &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="c1">## 1           43.9          17.2              201.       4202.</span>
</code></pre></div>

<p>Enfin, le paramètre <code>.names</code> de <code>across()</code> est également très pratique et permet notamment dans une instruction <code>mutate()</code> de créer de nouvelles colonnes nommées à partir des anciennes auxquelles on peut se référer avec <code>.col</code>. Par exemple, si je veux créer deux nouvelles colonnes passant les informations sur le bec en pouces mais en conservant les anciennes colonnes, je peux écrire :  </p>
<div class="highlight"><pre><span></span><code><span class="n">penguins</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&quot;bill&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.04</span><span class="p">,</span><span class="w"> </span><span class="n">.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pouces_{.col}&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="nf">contains</span><span class="p">(</span><span class="s">&quot;bill&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
<span class="c1">## # A tibble: 5 x 4</span>
<span class="c1">##   bill_length_mm bill_depth_mm pouces_bill_length_mm pouces_bill_depth_mm</span>
<span class="c1">##            &lt;dbl&gt;         &lt;dbl&gt;                 &lt;dbl&gt;                &lt;dbl&gt;</span>
<span class="c1">## 1           39.1          18.7                  1.56                0.748</span>
<span class="c1">## 2           39.5          17.4                  1.58                0.696</span>
<span class="c1">## 3           40.3          18                    1.61                0.72 </span>
<span class="c1">## 4           NA            NA                   NA                  NA    </span>
<span class="c1">## 5           36.7          19.3                  1.47                0.772</span>
</code></pre></div>

<h1 id="across-ca-tourne-comment"><code>across()</code>, ça tourne comment?</h1>
<p>À la sortie de la mise à jour de <code>dplyr</code>, il avait été signalé que la méthode <code>across()</code> impliquerait peut-être de légères pertes en termes de vitesse d'exécution par rapport aux anciennes méthodes <code>_at</code>, <code>_if</code> et <code>_all</code>. On a mis en évidence ce problème avec la version <code>1.0.2</code> de dplyr dans <a href="https://antoinesir.rbind.io/post/fonctionnement-de-across-dans-dplyr/" target="_blank">la première version de cet article</a>. Sur ce même modèle, on va comparer les instructions <code>_if</code> et <code>_at</code> d'un summarise groupé avec leurs équivalents dans <code>across()</code> pour différentes tailles d'échantillons et de groupes.   </p>
<h2 id="instructions-sur-lesquelles-on-compare-les-methodes">Instructions sur lesquelles on compare les méthodes</h2>
<p>On crée un tibble comportant 4 variables numériques et une variable facteur, et on va comparer la vitesse d'exécution des moyennes de ces variables numériques groupées par modalité de la variable facteur en faisant varier le nombre de lignes du tibble et le nombre de groupes (de modalités distinctes de la variable facteur). Le tibble est créé par exemple ainsi, pour 100 lignes et deux groupes :  </p>
<div class="highlight"><pre><span></span><code><span class="n">nbrow</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">100</span>
<span class="n">nbgpe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span>
<span class="nf">as_tibble</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="n">nbrow</span><span class="p">),</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nf">rnorm</span><span class="p">(</span><span class="n">nbrow</span><span class="p">),</span><span class="w"> </span>
<span class="w">                     </span><span class="n">x3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="n">nbrow</span><span class="p">),</span><span class="w"> </span><span class="n">x4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="n">nbrow</span><span class="p">),</span>
<span class="w">                     </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.factor</span><span class="p">(</span><span class="nf">sample</span><span class="p">(</span><span class="nf">floor</span><span class="p">(</span><span class="n">nbgpe</span><span class="p">),</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span>
<span class="w">                               </span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">arrange</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">),</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)))</span>
<span class="c1">## # A tibble: 100 x 5</span>
<span class="c1">##       x1    x2    x3    x4 y    </span>
<span class="c1">##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;</span>
<span class="c1">##  1 -3.36  0.9   0.32  0.36 2    </span>
<span class="c1">##  2 -3.04  0.92  0.61  0.46 2    </span>
<span class="c1">##  3 -2.4   1.37  0.32  0.98 2    </span>
<span class="c1">##  4 -2.08  1.64  0.87  0.72 2    </span>
<span class="c1">##  5 -2.05  1.22  0.62  0.79 2    </span>
<span class="c1">##  6 -1.78 -1.28  0.58  0.31 2    </span>
<span class="c1">##  7 -1.56  1.19  0.96  0.58 2    </span>
<span class="c1">##  8 -1.55 -1.18  0.4   0.85 2    </span>
<span class="c1">##  9 -1.47  1.77  0.71  0.21 2    </span>
<span class="c1">## 10 -1.29 -0.6   0.68  0.4  2    </span>
<span class="c1">## # … with 90 more rows</span>
</code></pre></div>

<p>Sur chaque tibble (chaque combinaison du nombre de lignes et de groupes), les différentes instructions testées sont les suivantes :  </p>
<div class="highlight"><pre><span></span><code><span class="c1"># summarise_if  </span>
<span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">group_by</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise_if</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w"> </span>

<span class="c1"># across + where()  </span>
<span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">group_by</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">))</span><span class="w">  </span>

<span class="c1"># summarise_at  </span>
<span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">group_by</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">mean</span><span class="p">)</span><span class="w"> </span>

<span class="c1"># across + starts_with()  </span>
<span class="n">data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">group_by</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">summarise</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">mean</span><span class="p">))</span>
</code></pre></div>

<p>Toutes les instructions font la même chose : une moyenne groupée par <code>y</code> des 4 variables numériques. L'idée est de vérifier que l'option <code>across</code> n'est pas plus lente que les options <code>summarise_if</code> et <code>summarise_at</code>. </p>
<h2 id="resultats-de-la-version-106">Résultats de la version 1.0.6</h2>
<p>Les résultats du <code>microbenchmark()</code> pour les différentes combinaisons de nombres de groupes et de lignes sont présentés dans un graphique qui représente la distribution du temps d’exécution des 10 occurences testées pour chaque méthode :     </p>
<p><img alt="Pelican" src="../images/across_files/unnamed-chunk-10-1.png"><!-- --></p>
<p>Sur nos exemples, il semblerait qu'<code>across</code> ait complètement rattrapé son retard sur ses équivalents <code>_at</code> et <code>_if</code>. Il semble même légèrement plus performant dans certains cas de figure.  </p>
<h2 id="resultats-de-la-version-100">Résultats de la version 1.0.0</h2>
<p>Pour illustrer le chemin parcouru, on peut refaire tourner cette même comparaison avec la version <code>1.0.0</code> de <code>dplyr</code> :  </p>
<p><img alt="Pelican" src="../images/across_files/unnamed-chunk-11-1.png"><!-- --></p>
<p>On constate bien que dans sa première version, <code>across</code> connaissait de bien moins bonnes performances, en particulier sur les dataframes avec beaucoup de lignes et/ou beaucoup de groupes. Les mises à jour successives ont donc bien permis de combler ces problèmes de performance et c'est une excellente nouvelle car au niveau de la syntaxe, nous, on adore!  </p>
<p>C'est tout pour aujourd'hui ! Comme d'habitude vous pouvez retrouver le fichier Rmarkdown ayant servi à générer cette note sur le <a href="https://github.com/Statoscop/notebooks-blog" target="_blank">github de Statoscop</a>.</p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Fonctionnement et performances d'across dans dplyr&amp;url=https://blog.statoscop.fr/fonctionnement-et-performances-dacross-dans-dplyr.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://blog.statoscop.fr/tag/r.html">R</a><a href="https://blog.statoscop.fr/tag/rstats.html">Rstats</a><a href="https://blog.statoscop.fr/tag/dplyr.html">dplyr</a><a href="https://blog.statoscop.fr/tag/across.html">across</a><a href="https://blog.statoscop.fr/tag/tidyverse.html">tidyverse</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
    
    <!-- Footer-->
    <footer class="footer py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-4 text-lg-left"> © Statoscop</div>
                <div class="col-lg-4 my-3 my-lg-0">
                    <a class="btn btn-dark btn-social mx-2" href="https://twitter.com/stato_scop" target="_blank"><i class="fab fa-twitter"></i></a>
                </div>
                <div class="col-lg-4 text-lg-left"> 
                    Blog publié avec <a class="js-scroll-trigger text-info" href="https://docs.getpelican.com/en/latest/"  target="_blank">Pelican</a> et
                     déployé sur <a class="js-scroll-trigger text-info" href="https://pages.github.com/"  target="_blank">Github Pages</a>.
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap core JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
    <!-- Third party plugin JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script type="text/javascript" src="https://blog.statoscop.fr/themes/statoscop/static/js/script.js"></script>

  </body>
</html>